/* FIXME: horribly incomplete */
#include "wvtest.h"
#include "wvx509.h"
#include "wvrsa.h"

void basic_test(WvX509Mgr *t509)
{
    WVPASS(t509->test());
    WVPASS(t509->isok());
    WVPASS(t509->get_subject() == "/CN=test.foo.com/DC=foo/DC=com");
    WVPASS(t509->get_issuer() == "/CN=test.foo.com/DC=foo/DC=com");
}


WVTEST_MAIN()
{
    static const char rsatextkey[] = 
"-----BEGIN RSA PRIVATE KEY-----\n"
"MIICXgIBAAKBgQDVQrw1PHhLm2qSGl24SAb4+mJb2jPW0UwsbodDG5Da0h405zUp\n"
"0U5yL7zKNQG6BYvuV5bCUeo6Q0uvd7D6eKE7VqzcVHVJfM2KvfKOI5eMiu76pz6V\n"
"XxnW53kEdw1ZiCnCQTK1JntJn41ZsWxY7mQ3PLBpcobNIdoyUDwXIOFwOQIDAQAB\n"
"AoGAVcyuqgB1KX4Sx0tCT4TzATLDZc8JMjEso2eoldA+XDtTGde3pOZn2DrqirP+\n"
"yNe4b6Dfr7iDMwOmLKdMFcl4nAmE8UnOQWFtW52SCWFGLdiSqD8hn0gbKoYvaGDu\n"
"vlqN/KvKen0AxiveYS6T24GFzHejr2RVcmT4m5UogNGFR90CQQD7VcPzfcPJZ3c1\n"
"jWiJvoUrzdLqYactRoKidm+O7AVjMU7xkXCPLGgXbzVoyuzx11z1D/nFUE615t/v\n"
"vkKVsnTDAkEA2TgOnSX6gSClZLUy7bWoSHQwcuj3Ogt2C0zA9p/sRgRaAuNCDWNC\n"
"OmkRAHjbOtJK0tChxoG0BYdyv9WIZ5bHUwJBANf+0xH06UezNY2+YzLNmyEUF8j5\n"
"93Q/fpEke6c2S0L94zxTo4pHvYU2O449pvgH/4lUG3FpHNvS+GzO8+Y2oYUCQQC8\n"
"Nf8rmOmqEvBcB0jegQUT6mDEYCk+yQl6FwInb0AZFtIrKGBmGzgaRkkuAInsOKQO\n"
"cCmMR3wFQmxh3ZI4N4PzAkEA4YbOing3yMDXxUFByZMKSX6oqwNePuVfK1IHmoUP\n"
"oZxEIiwTN7rE9kRV1OFDUwvGiqcegSxjf6SUgdpBC7Du9A==\n"
"-----END RSA PRIVATE KEY-----\n";
    
    static const char x509textkey[] = 
"-----BEGIN CERTIFICATE-----\n"
"MIICXDCCAcWgAwIBAgIEM7WjbjANBgkqhkiG9w0BAQUFADBBMRUwEwYDVQQDEwx0\n"
"ZXN0LmZvby5jb20xEzARBgoJkiaJk/IsZAEZEwNmb28xEzARBgoJkiaJk/IsZAEZ\n"
"EwNjb20wHhcNMDQwMzI2MjEwNTI5WhcNMTQwMzI0MjEwNTI5WjBBMRUwEwYDVQQD\n"
"Ewx0ZXN0LmZvby5jb20xEzARBgoJkiaJk/IsZAEZEwNmb28xEzARBgoJkiaJk/Is\n"
"ZAEZEwNjb20wgZ8wDQYJKoZIhvcNAQEBBQADgY0AMIGJAoGBANVCvDU8eEubapIa\n"
"XbhIBvj6YlvaM9bRTCxuh0MbkNrSHjTnNSnRTnIvvMo1AboFi+5XlsJR6jpDS693\n"
"sPp4oTtWrNxUdUl8zYq98o4jl4yK7vqnPpVfGdbneQR3DVmIKcJBMrUme0mfjVmx\n"
"bFjuZDc8sGlyhs0h2jJQPBcg4XA5AgMBAAGjYTBfMBEGCWCGSAGG+EIBAQQEAwIG\n"
"QDAbBglghkgBhvhCAQwEDhYMdGVzdC5mb28uY29tMA4GA1UdDwEB/wQEAwICpDAd\n"
"BgNVHSUEFjAUBggrBgEFBQcDAQYIKwYBBQUHAwIwDQYJKoZIhvcNAQEFBQADgYEA\n"
"D8WtaiTyx3DkHiJwC7EHVCOTqRctuS+3x1y0b2CO/3ijWASg+UDvGFKpAT4i6EF4\n"
"/e1aTgQEJ3a29XQEKamk5Py2AAb7acBbuKIUzEzcFx4QzzY+fdz1PgKz4DiUypZj\n"
"UFCAL0f74uuFTQ7ylt6F0m554LSniOHDOEzyBZZq/bk=\n"
"-----END CERTIFICATE-----\n";
    
    static const char certreq[] =
"-----BEGIN CERTIFICATE REQUEST-----\n"
"MIIBazCB1QIBADAsMSowKAYKCZImiZPyLGQBGRMadGVzdC5mb28uY29tL0RDPWZv\n"
"by9EQz1jb20wgZ8wDQYJKoZIhvcNAQEBBQADgY0AMIGJAoGBANVCvDU8eEubapIa\n"
"XbhIBvj6YlvaM9bRTCxuh0MbkNrSHjTnNSnRTnIvvMo1AboFi+5XlsJR6jpDS693\n"
"sPp4oTtWrNxUdUl8zYq98o4jl4yK7vqnPpVfGdbneQR3DVmIKcJBMrUme0mfjVmx\n"
"bFjuZDc8sGlyhs0h2jJQPBcg4XA5AgMBAAGgADANBgkqhkiG9w0BAQUFAAOBgQA3\n"
"+zj1ZCRGOqCyWJFT0J6P+LJxn57My7GKkUihXQFo6xym98kKfYwc7HTIVq+clnYA\n"
"rqmoQu1THFu6mVRdM9zp2zmRBtsmOxKkhx89RtNDhKu75HQE8S5xGmCPyZhFA0eX\n"
"elfqYQM30sg+MeZVTccV0wCd9augzYa2qA8MExu7SQ==\n"
"-----END CERTIFICATE REQUEST-----\n";
	
    
    WvString strcert = "3082025c308201c5a00302010202040a8c032d300d06092a864886f70d01010505003041311530130603550403130c746573742e666f6f2e636f6d31133011060a0992268993f22c6401191303666f6f31133011060a0992268993f22c6401191303636f6d301e170d3034303332363232323130315a170d3134303332343232323130315a3041311530130603550403130c746573742e666f6f2e636f6d31133011060a0992268993f22c6401191303666f6f31133011060a0992268993f22c6401191303636f6d30819f300d06092a864886f70d010101050003818d0030818902818100c1600bb6ad8ff70c4fa6a3e38d968f4defdefc43b09ab77c3f8863332139d85f17288f75df6525847bb87d7c32b899e832a88de333a609acb605b24c934dfc1d719147b955c79939189cc96565029467b1c1a7174a7796a92ee0ea18f585588ab9f4ff4cade641880ec9e464b3d79d0567cb119ed0f2379b4aead36a027234d70203010001a361305f301106096086480186f8420101040403020640301b06096086480186f842010c040e160c746573742e666f6f2e636f6d300e0603551d0f0101ff0404030202a4301d0603551d250416301406082b0601050507030106082b06010505070302300d06092a864886f70d01010505000381810083ac8f41265d2265930ae8c8942d837b3057231e82326da6297a3747414165f6fb3a3be8b66f974b5906b692704aa9e845159d9525d424f2f9faa872fda59279d97af8c5d56e776b9388db8bda7e912f47681ef92f5a0dbae8672bb9ffa5a574025855bcb2e4db0f0075b2c80b951d067d4d8a2bb8d2add4b84adbdacea3f997";
    WvString strrsa = "3082025d02010002818100c1600bb6ad8ff70c4fa6a3e38d968f4defdefc43b09ab77c3f8863332139d85f17288f75df6525847bb87d7c32b899e832a88de333a609acb605b24c934dfc1d719147b955c79939189cc96565029467b1c1a7174a7796a92ee0ea18f585588ab9f4ff4cade641880ec9e464b3d79d0567cb119ed0f2379b4aead36a027234d7020301000102818075cd00d5c45dd36e1887b7874415d82eee55b4efb782490cd3d74e3733a27d815026515ec93c60e2984c0785c5905791f06a662566ad5b6f6f6380fecd2dd0cb3f507c841221e4bcd9eeee7904f2dc0958ba51f7e2af971e29feae922a439d82bbe1135e51a4ebe6d7a5046e3cf492168e3dc9941142d63896e5db089bddb4c1024100ee384748e673a856a4f25657f0ce2d6d0fceb4005dd910c972e345acca5976fe56d39a1924a0f62d1c6908012ce3cd237db8a53aa5cc9897967354711f3cd0df024100cfcee8f78fa1f8bdbb3a281b763b5233c5e9226c4771db6026812a544237dc467c4b072d4c0d51a405df4f048a7fe2ca8bd6194709fd7bf4d24e64f2d76bc309024100eca826514af82d8d5e328e0ab164f285fd85391780244be40569b9674e6310aedded3b92acebe784ab4bc0b30238912c2812cebaf3c9ccf2137a21b27bf8fbfb0240517c0eb9d4266d04e8bf7b2e9983d54ddbd2f8de807d52ca370efaec2333083ad34e103860d3f02962ec176dee690b22e50644cf2849af2b66b3babdc65ec911024100a0d0e9bc4887f80e7745a0fca881f271cfc31c48106cac31941b74c78e6b91150b1159a03770927882cae3bcffadf064752601342c1e834d1a72a5f58107ff72";
    
    // Setup a new DN entry, like a server would set.
    WvString dName("cn=test.foo.com,dc=foo,dc=com"); 
    
    {
        WvX509Mgr t509(NULL);
	t509.decode(WvX509Mgr::RsaPEM, rsatextkey);
	t509.decode(WvX509Mgr::CertPEM, x509textkey);
	basic_test(&t509);
	WVPASS(t509.encode(WvX509Mgr::CertPEM) == x509textkey);
	WVPASS(t509.encode(WvX509Mgr::RsaPEM) == rsatextkey);
	WVPASS(t509.certreq() == certreq);
    }
    {
        WvX509Mgr t509(strcert, strrsa);
	basic_test(&t509);
    }
    {
	WvX509Mgr t509(dName, 1024);
	basic_test(&t509);
    }
    {
	WvRSAKey *rsa = new WvRSAKey(strrsa, true);
	WvX509Mgr t509(dName, rsa);
	basic_test(&t509);
    }
}
